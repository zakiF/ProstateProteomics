---
title: "Integrate all results"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: true
    toc_depth: 3
    number_sections: false
    theme: lumen
    code_folding: show
---

# Background

This analysis combines all aspects of our project. xxxx add more text - We want to be able query proteins of interest and evaluate their prognostic association with OS in mCRPC, plasma-tissue expression concordance, druggability status, and cross-reference against previously published prostate cancer biomarkers - And generate CPPS, stratify by median and generate nomogram. 

# Objectives

1. Load all required data
2. Example workflows

---

# Pre-processing

## Load packages

```{r setup, message=FALSE, warning=FALSE}
library(here)
library(tidyverse)
library(readxl)
library(patchwork)

# Set default theme
theme_set(theme_bw())
```

## Set up directories

```{r directories}
wd <- list()
wd$main <- here()
wd$data <- file.path(wd$main, "data")
wd$public <- file.path(wd$data, "public")
wd$output <- file.path(wd$main, "output")
wd$outCurr <- file.path(wd$output, "10_integration")

# Create output directory if it doesn't exist
if (!file.exists(wd$outCurr)) {
  dir.create(wd$outCurr, recursive = TRUE)
  cat("✓ Created output directory:", wd$outCurr, "\n")
} else {
  cat("✓ Output directory exists:", wd$outCurr, "\n")
}
```

---

# Obj 1: Load data

The dataset required for this analysis are ;

- Previous prostate biomarker records
- Annotated protein-drug targets
- Annotated cell-surface proteins
- mCRPC overexpressed DEPs
- Olink (plasma) NPX matrix + metadata
- Tissue (Mass-spect) matrix + metadata

We also need to load the expression matrix proteomics data (public, mass-spec tissue) and our Olink (plamsa) matrix.

Finally, we need to clinical metadata file

Lets load the individual data from all previous sessions

## Expression data

Lets read in the public data with their metadata

```{r}

```

Lets read in the Olink (plasma data) with their metadata

```{r}
mat_exp <- readRDS(file.path(wd$outData, "Olink_expMat.RDS"))
meta_olink <- readRDS(file.path(wd$outData, "Olink_Meta.RDS"))
```


The matching protein IDs from public and our Data

```{r}

```




## Biomarker records

Previous prostate biomarkers records

```{r}
# Read the protein biomarker table
protein_table <- read_excel(file.path(wd$data, "updated_2024/Protein biomarker pubs mCRPC_zaki_edit.xlsx"))

# Use Edited_name column for protein names (cleaner version)
protein_markers_col <- protein_table$`Edited_name`
# Function to parse sample-type-specific proteins
# Handles formats like "Tissue-based (DST, COL3A1) Urine-based (COL1A1, COL3A1)"
parse_proteins_with_sample_type <- function(markers_text, study_index) {
  proteins_list <- list()

  if (is.na(markers_text) || markers_text == "") {
    return(proteins_list)
  }

  # Check if the text contains sample type markers
  has_tissue <- grepl("Tissue-based\\s*\\(", markers_text, ignore.case = TRUE)
  has_plasma <- grepl("Plasma-based\\s*\\(", markers_text, ignore.case = TRUE)
  has_urine <- grepl("Urine-based\\s*\\(", markers_text, ignore.case = TRUE)

  if (has_tissue || has_plasma || has_urine) {
    # Parse each sample type separately

    # Extract Tissue-based proteins
    if (has_tissue) {
      tissue_match <- regmatches(markers_text, gregexpr("Tissue-based\\s*\\(([^)]+)\\)", markers_text, ignore.case = TRUE, perl = TRUE))[[1]]
      if (length(tissue_match) > 0) {
        tissue_proteins <- gsub(".*\\(([^)]+)\\).*", "\\1", tissue_match)
        tissue_proteins <- unlist(strsplit(tissue_proteins, ",\\s*"))
        tissue_proteins <- trimws(tissue_proteins)
        tissue_proteins <- gsub("^and\\s+", "", tissue_proteins, ignore.case = TRUE)
        tissue_proteins <- trimws(tissue_proteins)
        tissue_proteins <- tissue_proteins[tissue_proteins != ""]

        for (p in tissue_proteins) {
          proteins_list[[length(proteins_list) + 1]] <- list(name = p, sample_type = "Tissue")
        }
      }
    }

    # Extract Plasma-based proteins
    if (has_plasma) {
      plasma_match <- regmatches(markers_text, gregexpr("Plasma-based\\s*\\(([^)]+)\\)", markers_text, ignore.case = TRUE, perl = TRUE))[[1]]
      if (length(plasma_match) > 0) {
        plasma_proteins <- gsub(".*\\(([^)]+)\\).*", "\\1", plasma_match)
        plasma_proteins <- unlist(strsplit(plasma_proteins, ",\\s*"))
        plasma_proteins <- trimws(plasma_proteins)
        plasma_proteins <- gsub("^and\\s+", "", plasma_proteins, ignore.case = TRUE)
        plasma_proteins <- trimws(plasma_proteins)
        plasma_proteins <- plasma_proteins[plasma_proteins != ""]

        for (p in plasma_proteins) {
          proteins_list[[length(proteins_list) + 1]] <- list(name = p, sample_type = "Plasma")
        }
      }
    }

    # Extract Urine-based proteins
    if (has_urine) {
      urine_match <- regmatches(markers_text, gregexpr("Urine-based\\s*\\(([^)]+)\\)", markers_text, ignore.case = TRUE, perl = TRUE))[[1]]
      if (length(urine_match) > 0) {
        urine_proteins <- gsub(".*\\(([^)]+)\\).*", "\\1", urine_match)
        urine_proteins <- unlist(strsplit(urine_proteins, ",\\s*"))
        urine_proteins <- trimws(urine_proteins)
        urine_proteins <- gsub("^and\\s+", "", urine_proteins, ignore.case = TRUE)
        urine_proteins <- trimws(urine_proteins)
        urine_proteins <- urine_proteins[urine_proteins != ""]

        for (p in urine_proteins) {
          proteins_list[[length(proteins_list) + 1]] <- list(name = p, sample_type = "Urine")
        }
      }
    }
  } else {
    # No sample type specified - parse normally
    proteins <- unlist(strsplit(markers_text, ",\\s*"))
    proteins <- trimws(proteins)
    proteins <- gsub("^and\\s+", "", proteins, ignore.case = TRUE)
    proteins <- trimws(proteins)
    proteins <- proteins[proteins != ""]

    for (p in proteins) {
      proteins_list[[length(proteins_list) + 1]] <- list(name = p, sample_type = NA)
    }
  }

  return(proteins_list)
}

# Extract all proteins with their sample types
all_protein_entries <- list()
for (i in 1:nrow(protein_table)) {
  markers <- protein_markers_col[i]
  proteins_in_study <- parse_proteins_with_sample_type(markers, i)
  all_protein_entries[[i]] <- proteins_in_study
}

# Create unique protein identifiers
# Just use protein names without sample type suffix
all_proteins_raw <- lapply(all_protein_entries, function(study) {
  sapply(study, function(p) p$name)
}) %>% unlist()


biom_unique_proteins <- sort(unique(all_proteins_raw))
```

## Annotated protein-drug target

Lets read in the whole database 


```{r}
# Downloaded the file from DrugBank
df_target <- read.csv(file.path(wd$data, "DrugBank/drugbank_all_target_polypeptide_ids.csv/pharmacologically_active.csv"))
df_vocab <- read.csv(file.path(wd$data, "DrugBank/drugbank vocabulary.csv"))
```

Manual addition of drug targets

```{r}
df_target_manual <- read.delim(file.path(wd$data, "Drug_review/protein_drug_associations.tsv"),
                               sep = "\t", 
                               stringsAsFactors = FALSE)
```

Get a final list combining both

```{r}
df_target_sub <- df_target %>% select(Gene.Name, Drug.IDs) %>% 
  # Ensure one gene row for each drug
  group_by(Gene.Name) %>%
  summarise(
    DrugBank.ID = str_c(unique(unlist(str_split(Drug.IDs, ","))), collapse = ",")
  )
```

Replace DrugID with common name

```{r}
df_vocab_sub <- df_vocab %>% select(DrugBank.ID, Common.name)
# Replace each DrugBank ID with the corresponding Common name
xxxx <- xxxx %>%
  # Split the Drug.IDs by semicolon
  mutate(DrugBank.ID = str_split(DrugBank.ID, "; ")) %>%
  # Use a custom function to replace IDs with common names
  mutate(drugname = sapply(DrugBank.ID, function(ids) {
    # Join the common names of the IDs in the list
    names <- df_vocab_sub %>% 
      filter(DrugBank.ID %in% ids) %>%
      pull(`Common.name`)
    # Combine the common names into a single string
    str_c(names, collapse = "; ")
  })) %>%
  mutate(DrugBank.ID = as.character(DrugBank.ID))  # Clean up the original Drug.IDs column if desired
```


We include additional annotations of drug that was done through manual curations

```{r}
# Proteins that are drug target from manual curations
dt_manual <- df_target_manual %>% filter(Drug_Association == "Yes") %>% pull (Protein)
# Add a new column called is_Dx (is Drug Target) to indicate if records was noted
xxxx <- xxxx %>% 
  mutate(is_Dx = case_when(!is.na(DrugBank.ID) | Assay %in% dt_manual ~ "Yes",
                           TRUE ~ "No"))
```

## Annotated cell-surface proteins

```{r}
# List of cell surface markers
cs <- read.delim(file.path(wd$outData, "CS_human.txt"))
cs_prot <- unique(cs$Approved.symbol)
```


## mCRPC DEPs

The mCRPC DEP are genes considered over-expressed in mCRPc

```{r}
df_DEPs <- read.csv(file.path(wd$outCurr, "HR_values_mCRPC_specific_multivariate_cell_surface.csv"))

# Considered prognostic
prog_prot <- df_DEPs %>% filter(Multi_Sig == "Yes") %>% pull(Assay) %>% unique()
```



# Objective 2: Complex heatmap



